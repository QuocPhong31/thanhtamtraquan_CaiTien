<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Thanh toán</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- font giống product -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: Inter, sans-serif;
      background: #f6f7fb;
      padding: 30px;
    }
    .box {
      max-width: 480px;
      margin: auto;
      background: #fff;
      border-radius: 14px;
      padding: 24px;
      box-shadow: 0 12px 30px rgba(0,0,0,.1);
    }
    .title {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 12px;
      text-align: center;
    }
    .amount {
      font-size: 26px;
      font-weight: 700;
      color: #16a34a;
      text-align: center;
      margin-bottom: 20px;
    }
    .bank-box {
      background: #fff3cd;
      border-radius: 12px;
      padding: 16px;
      display: flex;
      gap: 14px;
      align-items: center;
    }
    .bank-info {
      flex: 1;
      font-size: 14px;
      line-height: 1.6;
    }
    .bank-info b {
      font-weight: 600;
    }
    .qr img {
      width: 140px;
      border-radius: 8px;
      background: #fff;
    }
    .order-code {
      text-align: center;
      font-weight: 600;
      margin-top: 16px;
    }
    button {
      margin-top: 20px;
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 8px;
      background: #d81b60;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
    }

    .form-group {
      margin-bottom: 14px;
    }
    .form-group label {
      font-weight: 600;
      font-size: 14px;
      display: block;
      margin-bottom: 4px;
    }
    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ddd;
      font-size: 14px;
    }
  </style>
</head>

<body>

<div class="box" style="max-width: 900px;">
  <div style="display:flex; gap:24px; flex-wrap:wrap">

    <!-- LEFT: CONTACT INFO -->
    <div style="flex:1; min-width:260px">
      <h3>Thông tin liên hệ</h3>

      <div class="form-group">
        <label>Họ tên *</label>
        <input id="hoTen" type="text" placeholder="Nguyễn Văn A" />
      </div>

      <div class="form-group">
        <label>Số điện thoại *</label>
        <input id="sdt" type="tel" placeholder="090xxxxxxx" />
      </div>

      <div class="form-group">
        <label>Email (không bắt buộc)</label>
        <input id="email" type="email" placeholder="email@gmail.com" />
      </div>

      <div class="form-group">
        <label>Địa chỉ giao hàng *</label>
        <textarea id="diaChi" rows="3"
          placeholder="Số nhà, đường, phường/xã, quận/huyện, tỉnh/thành"></textarea>
      </div>
    </div>

    <!-- RIGHT: PAYMENT INFO -->
    <div style="flex:1; min-width:260px">
      <div class="title">Thông tin chuyển khoản</div>

      <div class="amount" id="amountText">0 đ</div>

      <div id="order-products" style="margin-top:16px"></div>
      <div class="bank-box">
        <div class="bank-info" id="bankInfo">Đang tải...</div>
        <div class="qr"><img id="qrImg" /></div>
      </div>

      <div class="order-code">
        Nội dung chuyển khoản: <span id="orderCode"></span>
      </div>

      <button id="confirmBtn">Tôi đã thanh toán</button>
    </div>

  </div>
</div>


<!-- ✅ DÙNG CHUNG app.js -->
<script src="../app.js"></script>

<script>
/* ================= CART ================= */
let cart = JSON.parse(localStorage.getItem("checkout_cart") || "null");

if (!cart || cart.length === 0) {
  cart = getCart(); // lấy cart chính
}

if (!cart || cart.length === 0) {
  alert("Không có đơn hàng");
  location.href = "/Product/cart.html";
}
renderOrderProducts(cart);

const tenSanPham = cart.map(p => p.name).join(", ");
const soLuong = cart.map(p => p.qty).join(",");

let total = 0;
cart.forEach(p => total += p.price * p.qty);

// document.getElementById("amountText").innerText =
//   total.toLocaleString("vi-VN") + " đ";
document.getElementById("amountText").innerText = formatVND(total);

function renderOrderProducts(cart) {
  const box = document.getElementById("order-products");
  if (!box) return;

  box.innerHTML = cart.map(p => `
    <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px">
      <img src="${API_BASE + p.image}"
           style="width:60px;height:60px;object-fit:cover;border-radius:8px">

      <div style="flex:1">
        <div style="font-weight:600">${p.name}</div>
        <div style="font-size:13px;color:#555">
          ${p.qty} × ${formatVND(p.price)}đ
        </div>
      </div>

      <div style="font-weight:600">
        ${(p.qty * p.price).toLocaleString("vi-VN")}đ
      </div>
    </div>
  `).join("");
}

function generateOrderCode() {
  const num = Math.floor(10000 + Math.random() * 90000); // 5 số
  return "DH" + num;
}

const orderCode = generateOrderCode();
document.getElementById("orderCode").innerText = orderCode;

/* ================= LOAD PAYMENT ================= */
async function loadPayment() {
  const res = await fetch(API_BASE + "api/payments/active", {
    credentials: "include"
  });

  if (!res.ok) {
    document.getElementById("bankInfo").innerText =
      "Chưa cấu hình thanh toán";
    return;
  }

  const p = await res.json();

  document.getElementById("bankInfo").innerHTML = `
    <div><b>Ngân hàng:</b> ${p.nganHang}</div>
    <div><b>Số tài khoản:</b> ${p.soTaiKhoan}</div>
    <div><b>Chủ tài khoản:</b> ${p.chuTaiKhoan}</div>
  `;

  document.getElementById("qrImg").src = API_BASE + p.anhQR;
}

loadPayment();

/* ================= CONFIRM ================= */
document.getElementById("confirmBtn").onclick = async () => {
  const hoTen = document.getElementById("hoTen").value.trim();
  const sdt = document.getElementById("sdt").value.trim();
  const email = document.getElementById("email").value.trim();
  const diaChi = document.getElementById("diaChi").value.trim();

  if (!hoTen || !sdt || !diaChi) {
    alert(
      'Bạn cần nhập đầy đủ thông tin liên hệ trước khi nhấn "Tôi đã thanh toán"'
    );
    return;
  }

  await fetch(API_BASE + "api/order/create", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      hoTen,
      sdt,
      email,
      diaChi,
      tenSanPham,
      soLuong,
      thongTinCK: orderCode,
      amount: total,
      method: "BANK_TRANSFER"
    })
  });

  // XÓA TOÀN BỘ GIỎ HÀNG
  localStorage.removeItem("checkout_cart");
  localStorage.removeItem("cart");

  // nếu bạn dùng function trong app.js
  updateCartBadge?.([]);

  // thông báo
  alert("Đã gửi yêu cầu thanh toán. Shop sẽ xác nhận!");

  // quay về trang chủ
  location.href = "/";
};

</script>

</body>
</html>
