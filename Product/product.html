<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Chi ti·∫øt s·∫£n ph·∫©m</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- font hi·ªán ƒë·∫°i, h∆°i tr·∫ª trung -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
  <!-- main product stylesheet (moved from inline) -->
  <link rel="stylesheet" href="../Style/styleProduct.css">
</head>
<body>
  <div class="wrap">
    <div id="product-detail" class="loading">ƒêang t·∫£i...</div>
  </div>

<script>
  const API_BASE = "http://127.0.0.1:5000";

  function buildImageUrl(raw) {
    if (!raw) return API_BASE + "/images/placeholder.jpg";
    raw = String(raw).trim();
    if (raw.startsWith("http://") || raw.startsWith("https://")) return raw;
    if (raw.startsWith("/")) return API_BASE + raw;
    return API_BASE + "/" + raw.replace(/^\/+/, "");
  }

  function escapeHtml(s){ if(!s && s !== 0) return ""; return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;"); }

  const params = new URLSearchParams(location.search);
  const productId = params.get("id");
  const root = document.getElementById("product-detail");

  if (!productId) {
    root.innerHTML = `<div class="card"><div style="padding:18px;">Kh√¥ng x√°c ƒë·ªãnh s·∫£n ph·∫©m. <a href="../index.html" class="back">Quay v·ªÅ</a></div></div>`;
  } else {
    (async function load(){
      try {
        const res = await fetch(`${API_BASE}/api/products/${productId}`, { credentials: "include" });
        if (!res.ok) {
          const txt = await res.text().catch(()=>"");
          throw new Error("API tr·∫£ l·ªói " + res.status + (txt ? " ‚Äî "+txt : ""));
        }
        const p = await res.json();
        if (p.msg && !p.id) throw new Error(p.msg || "Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m");

        // map nhi·ªÅu t√™n tr∆∞·ªùng
        const title = p.title || p.tenSanPham || p.ten_san_pham || p.name || "";
        const priceVal = (p.price ?? p.gia ?? null);
        const price = priceVal !== null && priceVal !== undefined && priceVal !== "" ? new Intl.NumberFormat('vi-VN').format(priceVal) + 'ƒë' : 'Li√™n h·ªá';
        const desc = p.description || p.moTa || p.mo_ta || p.desc || "";
        const qty = (p.soLuong ?? p.so_luong ?? p.quantity ?? null);
        const origin = p.xuatXu || p.xuat_xu || p.origin || p.nguonGoc || "";
        const huongVi = p.huongVi || p.huong_vi || p.flavor || "";
        const congDung = p.congDung || p.cong_dung || p.uses || "";
        const cachPha = p.cachPha || p.cach_pha || p.instructions || "";
        const khoiLuongHop = p.khoiLuongHop || p.khoi_luong_hop || p.khoi_luong || "";

        const img = buildImageUrl(p.image || p.anh || p.anh || "");

        const html = `
          <div class="card">
            <div class="left">
              <div class="prod-img">
                <img src="${escapeHtml(img)}" alt="${escapeHtml(title)}" onerror="this.src='${API_BASE}/images/placeholder.jpg'"/>
              </div>
            </div>

            <div class="right">
              <div class="title-row">
                <h1 class="product-title">${escapeHtml(title)}</h1>
                <div class="price-badge">${escapeHtml(price)}</div>
              </div>

              <div class="attrs">
                ${ qty !== null && qty !== undefined && qty !== "" ? `<div class="attr"><span class="label">S·ªë l∆∞·ª£ng</span><span class="value">${escapeHtml(qty)}</span></div>` : "" }
                ${ khoiLuongHop ? `<div class="attr"><span class="label">Kh·ªëi l∆∞·ª£ng</span><span class="value">${escapeHtml(khoiLuongHop)}</span></div>` : "" }
                ${ origin ? `<div class="attr" style="min-width:unset"><span class="label">Xu·∫•t x·ª©</span><span class="value origin-pill">${escapeHtml(origin)}</span></div>` : "" }
              </div>

              ${ desc ? `<div class="section"><h4>üìù M√¥ t·∫£</h4><div class="desc">${escapeHtml(desc)}</div></div>` : "" }
              ${ huongVi ? `<div class="section"><h4>üçÉ H∆∞∆°ng v·ªã</h4><div class="desc">${escapeHtml(huongVi)}</div></div>` : "" }
              ${ congDung ? `<div class="section"><h4>üí™ C√¥ng d·ª•ng</h4><div class="desc">${escapeHtml(congDung)}</div></div>` : "" }
              ${ cachPha ? `<div class="section"><h4>‚òï C√°ch pha</h4><div class="desc">${escapeHtml(cachPha)}</div></div>` : "" }

              <a class="back" href="../index.html">‚Üê Quay v·ªÅ</a>
            </div>
          </div>
        `;
        root.innerHTML = html;
      } catch (err) {
        console.error(err);
        root.innerHTML = `<div class="card"><div style="padding:18px;color:#b00020">L·ªói khi t·∫£i s·∫£n ph·∫©m: ${escapeHtml(err.message || err)}</div><div style="padding:18px;"><a class="back" href="../index.html">Quay v·ªÅ</a></div></div>`;
      }
    })();
  }
</script>
</body>
</html>
