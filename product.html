<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Chi ti·∫øt s·∫£n ph·∫©m</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- font hi·ªán ƒë·∫°i, h∆°i tr·∫ª trung -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
  <!-- main product stylesheet (moved from inline) -->
  <link rel="stylesheet" href="./Style/styleProduct.css">
</head>
<body>
  <div class="wrap">
    <div id="product-detail" class="loading">ƒêang t·∫£i...</div>
  </div>

<script src="app.js"></script>
<script>
  // const API_BASE = "https://thanhtamtraquanp.pythonanywhere.com/";
  // const API_BASE = "http://127.0.0.1:5000/";

  function buildImageUrl(raw) {
    if (!raw) return API_BASE + "/images/placeholder.jpg";
    raw = String(raw).trim();
    if (raw.startsWith("http://") || raw.startsWith("https://")) return raw;
    if (raw.startsWith("/")) return API_BASE + raw;
    return API_BASE + "/" + raw.replace(/^\/+/, "");
  }

  function escapeHtml(s){ if(!s && s !== 0) return ""; return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;"); }

  const params = new URLSearchParams(location.search);
  const productId = params.get("id");
  const root = document.getElementById("product-detail");

  // t·∫°o section (wrapper id = wrap-sec-xxx, inner id = sec-xxx)
  function mkSection(keyId, titleEmoji, titleText, content, hiddenByDefault=false) {
    if (!content) return "";
    const id = `sec-${keyId}`;
    const wrapId = `wrap-${id}`;
    const hiddenAttr = hiddenByDefault ? ' data-hidden="1" class="section hidden-section"' : ' class="section"';
    const clampClass = hiddenByDefault ? '' : 'clamped';
    const expandBtnHtml = hiddenByDefault ? '' : `<button class="expand-btn" data-target="${id}" data-reveals="sec-huong-vi,sec-cong-dung,sec-cach-pha">Xem th√™m</button>`;
    return `
      <div id="${wrapId}" ${hiddenAttr}>
        <h4>${titleEmoji} ${titleText}</h4>
        <div id="${id}" class="desc ${clampClass}">${content}</div>
        ${expandBtnHtml}
      </div>
    `;
  }

  // async function addToCartAPI(item){
  //   const res = await fetch(API_BASE + "/api/cart/add", {
  //     method: "POST",
  //     headers: { "Content-Type": "application/json" },
  //     credentials: "include",
  //     body: JSON.stringify(item)
  //   });

  //   if(!res.ok){
  //     alert("Th√™m v√†o gi·ªè th·∫•t b·∫°i");
  //     return;
  //   }

  //   const data = await res.json();

  //   const badge = document.getElementById("cart-count");
  //   if (badge) {
  //     badge.innerText = data.cart.length;
  //   }

  //   alert("ƒê√£ th√™m v√†o gi·ªè");
  // }



  if (!productId) {
    root.innerHTML = `<div class="card"><div style="padding:18px;">Kh√¥ng x√°c ƒë·ªãnh s·∫£n ph·∫©m. <a href="../index.html" class="back">Quay v·ªÅ</a></div></div>`;
  } else {
    (async function load(){
      try {
        const res = await fetch(`${API_BASE}/api/products/${productId}`, { credentials: "include" });
        if (!res.ok) {
          const txt = await res.text().catch(()=> "");
          throw new Error("API tr·∫£ l·ªói " + res.status + (txt ? " ‚Äî " + txt : ""));
        }
        const p = await res.json();
        if (p.msg && !p.id) throw new Error(p.msg || "Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m");

        const title = escapeHtml(p.title || p.tenSanPham || p.ten_san_pham || p.name || "");
        const priceVal = (p.price ?? p.gia ?? null);
        const price = priceVal !== null && priceVal !== undefined && priceVal !== "" ? new Intl.NumberFormat('vi-VN').format(priceVal) + 'ƒë' : 'Li√™n h·ªá';
        const descRaw = escapeHtml(p.description || p.moTa || p.mo_ta || p.desc || "");
        const qty = escapeHtml((p.soLuong ?? p.so_luong ?? p.quantity ?? ""));
        const origin = escapeHtml(p.xuatXu || p.xuat_xu || p.origin || p.nguonGoc || "");
        const huongVi = escapeHtml(p.huongVi || p.huong_vi || p.flavor || "");
        const congDung = escapeHtml(p.congDung || p.cong_dung || p.uses || "");
        const cachPha = escapeHtml(p.cachPha || p.cach_pha || p.instructions || "");
        const khoiLuongHop = escapeHtml(p.khoiLuongHop || p.khoi_luong_hop || p.khoi_luong || "");
        const img = buildImageUrl(p.image || p.anh || p.anh || "");

        const html = `
          <div class="card">
            <div class="left">
              <div class="prod-img">
                <img src="${escapeHtml(img)}" alt="${title}" onerror="this.src='${API_BASE}/images/placeholder.jpg'"/>
              </div>
            </div>

            <div class="right">
              <div class="title-row">
                <h1 class="product-title">${title}</h1>
                <div class="price-badge">${escapeHtml(price)}</div>
              </div>

              <div class="attrs">
                ${ qty ? `<div class="attr"><span class="label">S·ªë l∆∞·ª£ng</span><span class="value">${qty}</span></div>` : "" }
                ${ khoiLuongHop ? `<div class="attr"><span class="label">Kh·ªëi l∆∞·ª£ng</span><span class="value">${khoiLuongHop}</span></div>` : "" }
                ${ origin ? `<div class="attr" style="min-width:unset"><span class="label">Xu·∫•t x·ª©</span><span class="value origin-pill">${origin}</span></div>` : "" }
              </div>

              <div class="qty-cart-row">
  
                <div class="qty-line">
                  <button id="minus">-</button>
                  <input id="qty" value="1" min="1" type="number">
                  <button id="plus">+</button>
                </div>
                <button id="addCartBtn" class="add-cart-btn">TH√äM V√ÄO GI·ªé</button>
              </div>


              ${ mkSection("mo-ta", "üìù", "M√¥ t·∫£", descRaw, false) }
              ${ mkSection("huong-vi", "üçÉ", "H∆∞∆°ng v·ªã", huongVi, true) }
              ${ mkSection("cong-dung", "üí™", "C√¥ng d·ª•ng", congDung, true) }
              ${ mkSection("cach-pha", "‚òï", "C√°ch pha", cachPha, true) }

              <a class="back" href="index.html">‚Üê Quay v·ªÅ</a>
            </div>
          </div>
        `;
        root.innerHTML = html;

        // ƒêo·∫°n th√™m v√†o gi·ªè h√†ng
        const stock = Number(p.soLuong || 1);

        const qtyInput = document.getElementById("qty");
        document.getElementById("minus").onclick = () => {
          let v = Number(qtyInput.value);
          if(v > 1) qtyInput.value = v-1;
        };
        document.getElementById("plus").onclick = () => {
          let v = Number(qtyInput.value);
          if(v < stock) qtyInput.value = v+1;
        };

        document.getElementById("addCartBtn").onclick = () => {
          const qty = Number(qtyInput.value);
          if(qty < 1 || qty > stock){
            alert("S·ªë l∆∞·ª£ng kh√¥ng h·ª£p l·ªá!");
            return;
          }

          // addToCartAPI({
          //   type: "tea",
          //   id: p.id,
          //   name: p.title,
          //   price: p.price,
          //   image: p.image,
          //   qty: qty
          // });
          addToCart({
            type: "tea",
            id: p.id,
            name: p.title || p.tenSanPham,
            price: p.price || p.gia,
            image: p.image || p.anh,
            qty: qty
          });
          showAddToCartToast();
        };
        //=================================================

        // ƒë·∫£m b·∫£o c√°c section ·∫©n th·ª±c s·ª± b·ªã ·∫©n (ph√≤ng CSS load mu·ªôn)
        document.querySelectorAll('[data-hidden="1"]').forEach(w => w.classList.add('hidden-section'));

        // x·ª≠ l√Ω n√∫t Xem th√™m (ch·ªâ c√≥ trong wrap-sec-mo-ta)
        const expandBtn = document.querySelector('#wrap-sec-mo-ta .expand-btn');
        if (!expandBtn) return;

        // helper: di chuy·ªÉn n√∫t v√†o cu·ªëi wrapper c·ªßa id truy·ªÅn v√†o
        function moveBtnToWrapper(btn, wrapId) {
          const wrapper = document.getElementById(wrapId);
          if (!wrapper) return;
          // append button at the end of wrapper (so it appears below that section)
          wrapper.appendChild(btn);
        }
        // helper: move button back into mo-ta wrapper (it's originally there)
        function moveBtnBackToMoTa(btn) {
          const moWrap = document.getElementById('wrap-sec-mo-ta');
          if (!moWrap) return;
          // insert after the desc inside mo-ta wrapper
          moWrap.appendChild(btn);
        }

        expandBtn.addEventListener('click', (ev) => {
          const descId = expandBtn.getAttribute('data-target'); // sec-mo-ta
          const reveals = (expandBtn.getAttribute('data-reveals') || '').split(',').map(s=>s.trim()).filter(Boolean);
          const descEl = document.getElementById(descId);
          if (!descEl) return;

          const opening = !descEl.classList.contains('expanded');
          if (opening) {
            // m·ªü: show m√¥ t·∫£ ƒë·∫ßy ƒë·ªß
            descEl.classList.remove('clamped');
            descEl.classList.add('expanded');
            expandBtn.innerText = 'Thu g·ªçn';

            // hi·ªÉn th·ªã c√°c section ·∫©n l·∫ßn l∆∞·ª£t
            reveals.forEach(rid => {
              const wrap = document.getElementById('wrap-' + rid);
              if (wrap) wrap.classList.remove('hidden-section');
            });

            // DI CHUY·ªÇN n√∫t xu·ªëng d∆∞·ªõi c√πng c·ªßa section "c√°ch pha" n·∫øu t·ªìn t·∫°i,
            // n·∫øu kh√¥ng th√¨ xu·ªëng cu·ªëi "c√¥ng d·ª•ng" ho·∫∑c "h∆∞∆°ng v·ªã" t√πy order
            const preferred = ['wrap-sec-cach-pha','wrap-sec-cong-dung','wrap-sec-huong-vi'];
            let moved = false;
            for (const id of preferred) {
              const w = document.getElementById(id);
              if (w) { moveBtnToWrapper(expandBtn, id); moved = true; break; }
            }
            if (!moved) moveBtnBackToMoTa(expandBtn);

            // ƒë·∫£m b·∫£o cu·ªôn xu·ªëng cho tr·∫£i nghi·ªám: scroll t·ªõi n√∫t sau khi reveal
            setTimeout(()=> expandBtn.scrollIntoView({behavior:'smooth', block:'end'}), 150);
          } else {
            // ƒë√≥ng l·∫°i: g√≥i m√¥ t·∫£ & ·∫©n c√°c section
            descEl.classList.add('clamped');
            descEl.classList.remove('expanded');
            expandBtn.innerText = 'Xem th√™m';

            // ·∫©n c√°c section ƒë√£ reveal
            reveals.forEach(rid => {
              const wrap = document.getElementById('wrap-' + rid);
              if (wrap) wrap.classList.add('hidden-section');
            });

            // chuy·ªÉn n√∫t tr·ªü v·ªÅ v·ªã tr√≠ ban ƒë·∫ßu (trong mo-ta)
            moveBtnBackToMoTa(expandBtn);

            // cu·ªôn nh·∫π t·ªõi mo-ta
            setTimeout(()=> {
              const moWrap = document.getElementById('wrap-sec-mo-ta');
              if (moWrap) moWrap.scrollIntoView({behavior:'smooth', block:'nearest'});
            }, 120);
          }
        });

      } catch (err) {
        console.error(err);
        root.innerHTML = `<div class="card"><div style="padding:18px;color:#b00020">L·ªói khi t·∫£i s·∫£n ph·∫©m: ${escapeHtml(err.message || err)}</div><div style="padding:18px;"><a class="back" href="../index.html">Quay v·ªÅ</a></div></div>`;
      }
    })();
  }
</script>
</body>
</html>
