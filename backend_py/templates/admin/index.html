{% extends "admin/base.html" %}

{% block content %}
<div class="row">

  <!-- LEFT -->
  <div class="col-lg-3 mb-4">
    <div class="card">
      <div class="card-header"><strong>NÃºt Ä‘iá»u hÆ°á»›ng</strong></div>
      <div class="card-body d-grid gap-2">
        <a href="https://shop.thanhtamtraquan.com" target="_blank" class="btn btn-outline-primary">
          ğŸŒ Website
        </a>
        <a href="https://dangkylich.thanhtamtraquan.com" target="_blank" class="btn btn-outline-success">
          ğŸ“… ÄÄƒng kÃ½ lá»‹ch
        </a>
        <a href="https://kanban.thanhtamtraquan.com" target="_blank" class="btn btn-outline-dark">
          ğŸ“‹ Kanban
        </a>
      </div>
    </div>
  </div>

  <!-- RIGHT -->
  <div class="col-lg-9">

    <div class="card">
      <div class="card-header">
        <strong>Thá»‘ng kÃª lÆ°á»£t truy cáº­p</strong>
      </div>

      <div class="card-body">
        <div class="row g-3">

          <div class="col-md-4">
            <div class="border rounded p-3 text-center">
              <h6>Theo ngÃ y</h6>
              <div id="dailyTotal" class="fs-4 fw-bold">0</div>
            </div>
          </div>

          <div class="col-md-4">
            <div class="border rounded p-3 text-center">
              <h6 id="monthlyTitle">Theo thÃ¡ng</h6>
              <div id="monthlyTotal" class="fs-4 fw-bold">0</div>
            </div>
          </div>

          <div class="col-md-4">
            <div class="border rounded p-3 text-center">
              <h6>Theo nÄƒm</h6>
              <div id="yearlyTotal" class="fs-5 fw-bold">0</div>
            </div>
          </div>

        </div>
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block scripts %}
<!-- scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  //hÃ m thá»‘ng ke
  async function loadSummary() {
    const daily = await fetch("/admin/stats/summary/daily").then(r => r.json());
    document.getElementById("dailyTotal").innerText = daily.total + " lÆ°á»£t";

    const monthly = await fetch("/admin/stats/summary/monthly").then(r => r.json());

    document.getElementById("monthlyTitle").innerText =
      `Theo thÃ¡ng ${monthly.month}`;

    document.getElementById("monthlyTotal").innerText =
      `${monthly.total} lÆ°á»£t`;

    const yearly = await fetch("/admin/stats/summary/yearly").then(r => r.json());
    document.getElementById("yearlyTotal").innerText =
      `Tá»•ng ${yearly.from} â€“ ${yearly.to}: ${yearly.total} lÆ°á»£t`;
  }

  document.addEventListener("DOMContentLoaded", loadSummary);

  // biáº¿n admin do Flask truyá»n vÃ o
  const LOGGED_ADMIN = {{ admin|tojson | default('null') }};

  // helper DOM
  const el = sel => document.querySelector(sel);
  const els = sel => Array.from(document.querySelectorAll(sel));
  const apiBase = "";

  // TABS handlers + (khÃ´ng cÃ²n nÃºt top-right nÃªn khÃ´ng Ä‘iá»u khiá»ƒn hiá»ƒn thá»‹ chÃºng ná»¯a)
  function showView(name) {
    el("#view-overview")?.classList.toggle("hide", name !== "overview");
<!--    el("#view-users")?.classList.toggle("hide", name !== "users");-->
<!--    el("#view-products")?.classList.toggle("hide", name !== "products");-->
<!--    el("#view-backgrounds")?.classList.toggle("hide", name !== "backgrounds");-->
<!--    el("#view-contact")?.classList.toggle("hide", name !== "contact");-->

    ["overview","users","products","backgrounds","contact"].forEach(n => {
      el("#tab-" + n)?.classList.toggle("active", n === name);
    });

    if (name === "users") {
      loadUsers();
    }
  }


  // desktop tabs (in navbar)
  el("#tab-overview")?.addEventListener("click", ()=> showView("overview"));
<!--  el("#tab-users")?.addEventListener("click", ()=> showView("users"));-->
<!--  el("#tab-products")?.addEventListener("click", ()=> showView("products"));-->
<!--  el("#tab-backgrounds")?.addEventListener("click", () => showView("backgrounds"));-->
<!--  el("#tab-contact")?.addEventListener("click", () => showView("contact"));-->

  // mobile dropdown menu items
  els(".mobile-tab").forEach(a => {
    a.addEventListener("click", (ev) => {
      ev.preventDefault();
      const t = a.dataset.target || a.getAttribute("data-target");
      if (t) showView(t);
    });
  });

  // login / logout UI
  document.addEventListener("DOMContentLoaded", () => {
    if (LOGGED_ADMIN) {
      el("#nav-greeting").innerText =
        "Xin chÃ o " + (LOGGED_ADMIN.hoTen || LOGGED_ADMIN.taiKhoan || "");
      el("#card-login").classList.add("hide");
      el("#card-admin-info").classList.remove("hide");
    }

    // chá»‰ hiá»ƒn thá»‹ biá»ƒu Ä‘á»“
    showView("overview");
    loadUsers(); // preload Ä‘á»ƒ trÃ¡nh rá»—ng láº§n Ä‘áº§u
  });



  // login/logout (giá»¯ nguyÃªn logic nhÆ° trÆ°á»›c)
  el("#btn-login").addEventListener("click", async () => {
    const username = el("#login-username").value.trim();
    const password = el("#login-password").value.trim();
    if(!username || !password){ el("#login-msg").innerText = "Nháº­p tÃ i khoáº£n vÃ  máº­t kháº©u"; return; }
    try {
      const res = await fetch("/admin/login", {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        credentials: "same-origin",
        body: JSON.stringify({ username, password })
      });
      const j = await res.json();
      if(!res.ok){ el("#login-msg").innerText = j.msg || "Lá»—i login"; return; }
      window.location.href = "/admin/";
    } catch(e){ console.error(e); el("#login-msg").innerText = "KhÃ´ng thá»ƒ káº¿t ná»‘i server"; }
  });
  el("#btn-logout").addEventListener("click", async ()=> {
    try { await fetch("/admin/logout", { method: "GET", credentials: "same-origin" }); } catch(e) { console.error(e); }
    window.location.href = "/admin/login";
  });

  async function loadVisitStats() {
  const [daily, monthly, yearly] = await Promise.all([
    fetch("/admin/stats/summary/daily").then(r => r.json()),
    fetch("/admin/stats/summary/monthly").then(r => r.json()),
    fetch("/admin/stats/summary/yearly").then(r => r.json())
  ]);

  // CHá»ˆ HIá»‚N THá»Š Sá» â€“ KHÃ”NG MAP
  document.getElementById("daily-total").innerText =
    daily.total + " lÆ°á»£t";

  document.getElementById("monthly-total").innerText =
    monthly.total + " lÆ°á»£t";

  document.getElementById("yearly-total").innerText =
    `Tá»•ng ${yearly.from} â€“ ${yearly.to}: ${yearly.total} lÆ°á»£t`;
}

</script>
{% endblock %}
</body>
</html>
