{% extends "admin/base.html" %}

{% block content %}
<div class="row">

  <!-- LEFT -->
  <div class="col-lg-3 mb-4">
    <div class="card">
      <div class="card-header"><strong>NÃºt Ä‘iá»u hÆ°á»›ng</strong></div>
      <div class="card-body d-grid gap-2">
        <a href="https://shop.thanhtamtraquan.com" target="_blank" class="btn btn-outline-primary">
          ğŸŒ Website
        </a>
        <a href="https://dangkylich.thanhtamtraquan.com" target="_blank" class="btn btn-outline-success">
          ğŸ“… ÄÄƒng kÃ½ lá»‹ch
        </a>
        <a href="https://kanban.thanhtamtraquan.com" target="_blank" class="btn btn-outline-dark">
          ğŸ“‹ Kanban
        </a>
      </div>
    </div>
  </div>

  <!-- RIGHT -->
  <div class="col-lg-9">

    <div class="card">
      <div class="card-header">
        <strong>Thá»‘ng kÃª lÆ°á»£t truy cáº­p</strong>
      </div>

      <div class="card-body">
        <div class="row g-3">

          <div class="col-md-4">
            <div class="border rounded p-3 text-center">
              <h6>Theo ngÃ y</h6>
              <div id="dailyTotal" class="fs-4 fw-bold">0</div>
            </div>
          </div>

          <div class="col-md-4">
            <div class="border rounded p-3 text-center">
              <h6 id="monthlyTitle">Theo thÃ¡ng</h6>
              <div id="monthlyTotal" class="fs-4 fw-bold">0</div>
            </div>
          </div>

          <div class="col-md-4">
            <div class="border rounded p-3 text-center">
              <h6>Theo nÄƒm</h6>
              <div id="yearlyTotal" class="fs-5 fw-bold">0</div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <div class="card mt-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <strong>Thá»‘ng kÃª Doanh thu</strong>

        <select id="revenueFilter" class="form-select w-auto">
          <option value="month">Theo thÃ¡ng</option>
          <option value="quarter">Theo quÃ½</option>
          <option value="year">Theo nÄƒm</option>
        </select>
      </div>

      <div class="card-body">
        <div class="row text-center align-items-center">
          <div class="col-md-6">
            <h6>Booking</h6>
            <div class="chart-wrapper">
              <canvas id="bookingChart"></canvas>
            </div>
            <div class="fs-5 fw-bold mt-2" id="bookingTotal">0 Ä‘Æ¡n</div>
          </div>

          <div class="col-md-6">
            <h6>Revenue</h6>
            <div class="chart-wrapper">
              <canvas id="revenueChart"></canvas>
            </div>
            <div class="fs-5 fw-bold text-success mt-2" id="revenueTotal">0 â‚«</div>
          </div>
        </div>
      </div>
    </div>


  </div>
</div>
{% endblock %}

{% block scripts %}
<!-- scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  //hÃ m thá»‘ng ke
  async function loadSummary() {
    const daily = await fetch("/admin/stats/summary/daily").then(r => r.json());
    document.getElementById("dailyTotal").innerText = daily.total + " lÆ°á»£t";

    const monthly = await fetch("/admin/stats/summary/monthly").then(r => r.json());

    document.getElementById("monthlyTitle").innerText =
      `Theo thÃ¡ng ${monthly.month}`;

    document.getElementById("monthlyTotal").innerText =
      `${monthly.total} lÆ°á»£t`;

    const yearly = await fetch("/admin/stats/summary/yearly").then(r => r.json());
    document.getElementById("yearlyTotal").innerText =
      `Tá»•ng ${yearly.from} â€“ ${yearly.to}: ${yearly.total} lÆ°á»£t`;
  }

  document.addEventListener("DOMContentLoaded", loadSummary);

  // biáº¿n admin do Flask truyá»n vÃ o
  const LOGGED_ADMIN = {{ admin|tojson | default('null') }};

  // helper DOM
  const el = sel => document.querySelector(sel);
  const els = sel => Array.from(document.querySelectorAll(sel));
  const apiBase = "";

  // TABS handlers + (khÃ´ng cÃ²n nÃºt top-right nÃªn khÃ´ng Ä‘iá»u khiá»ƒn hiá»ƒn thá»‹ chÃºng ná»¯a)
  function showView(name) {
    el("#view-overview")?.classList.toggle("hide", name !== "overview");

    ["overview","users","products","backgrounds","contact"].forEach(n => {
      el("#tab-" + n)?.classList.toggle("active", n === name);
    });

    if (name === "users") {
      loadUsers();
    }
  }


  // desktop tabs (in navbar)
  el("#tab-overview")?.addEventListener("click", ()=> showView("overview"));

  // mobile dropdown menu items
  els(".mobile-tab").forEach(a => {
    a.addEventListener("click", (ev) => {
      ev.preventDefault();
      const t = a.dataset.target || a.getAttribute("data-target");
      if (t) showView(t);
    });
  });

  // login / logout UI
  document.addEventListener("DOMContentLoaded", () => {
    if (LOGGED_ADMIN) {
      el("#nav-greeting").innerText =
        "Xin chÃ o " + (LOGGED_ADMIN.hoTen || LOGGED_ADMIN.taiKhoan || "");
      el("#card-login").classList.add("hide");
      el("#card-admin-info").classList.remove("hide");
    }

    // chá»‰ hiá»ƒn thá»‹ biá»ƒu Ä‘á»“
    showView("overview");
    loadUsers(); // preload Ä‘á»ƒ trÃ¡nh rá»—ng láº§n Ä‘áº§u
  });



  // login/logout (giá»¯ nguyÃªn logic nhÆ° trÆ°á»›c)
  const btnLogin = el("#btn-login");
  if (btnLogin) {
    btnLogin.addEventListener("click", async () => {
      const username = el("#login-username").value.trim();
      const password = el("#login-password").value.trim();
      if(!username || !password){ el("#login-msg").innerText = "Nháº­p tÃ i khoáº£n vÃ  máº­t kháº©u"; return; }
      try {
        const res = await fetch("/admin/login", {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          credentials: "same-origin",
          body: JSON.stringify({ username, password })
        });
        const j = await res.json();
        if(!res.ok){ el("#login-msg").innerText = j.msg || "Lá»—i login"; return; }
        window.location.href = "/admin/";
      } catch(e){ console.error(e); el("#login-msg").innerText = "KhÃ´ng thá»ƒ káº¿t ná»‘i server"; }
    });
  }

  const btnLogout = el("#btn-logout");
  if (btnLogout) {
    el("#btn-logout").addEventListener("click", async ()=> {
      try { await fetch("/admin/logout", { method: "GET", credentials: "same-origin" }); } catch(e) { console.error(e); }
      window.location.href = "/admin/login";
    });
  }

  //thá»‘ng kÃª doanh thu
  let bookingChart, revenueChart;
  async function loadRevenue() {
    const mode = document.getElementById("revenueFilter").value;
    const now = new Date();
    const year = now.getFullYear();
    const month = now.getMonth() + 1;
    const quarter = Math.floor((month - 1) / 3) + 1;

    let url = `/admin/stats/revenue?mode=${mode}&year=${year}`;
    if (mode === "month") url += `&month=${month}`;
    if (mode === "quarter") url += `&quarter=${quarter}`;

    const res = await fetch(url);
    const data = await res.json();

    // TEXT
    document.getElementById("bookingTotal").innerText =
      `${data.booking} Ä‘Æ¡n`;

    document.getElementById("revenueTotal").innerText =
      data.revenue.toLocaleString("vi-VN") + " â‚«";

    const unconfirmed = data.booking - data.confirmed;

    // DESTROY OLD CHARTS
    bookingChart?.destroy();
    revenueChart?.destroy();

    // BOOKING CHART
    bookingChart = new Chart(
      document.getElementById("bookingChart"),
      {
        type: "doughnut",
        data: {
          labels: ["Tá»•ng Ä‘Æ¡n"],
          datasets: [{
            data: [data.booking],
            backgroundColor: ["#1db954"]
          }]
        },
        options: {
          plugins: { legend: { display: false } }
        }
      }
    );

    // REVENUE CHART
    revenueChart = new Chart(
      document.getElementById("revenueChart"),
      {
        type: "doughnut",
        data: {
          labels: ["ÄÃ£ xÃ¡c nháº­n", "ChÆ°a / Huá»·"],
          datasets: [{
            data: [data.confirmed, unconfirmed],
            backgroundColor: ["#1db954", "#e5e7eb"]
          }]
        },
        options: {
          plugins: { legend: { position: "bottom" } }
        }
      }
    );
  }

  document.addEventListener("DOMContentLoaded", () => {
    loadRevenue();

    const filter = document.getElementById("revenueFilter");
    if (filter) {
      filter.addEventListener("change", loadRevenue);
    }
  });

</script>
{% endblock %}
</body>
</html>
